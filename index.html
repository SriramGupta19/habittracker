<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Habit Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --secondary: #6366f1;
      --accent: #10b981;
      --background: #f9fafb;
      --text: #1f2937;
      --muted: #6b7280;
      --error: #ef4444;
      --white: #ffffff;
      --card-bg: #ffffff;
      --day-cell-bg: #f3f4f6;
      --shadow: 0 4px 8px rgba(0,0,0,0.05);
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      --font-size-base: 16px;
    }

    [data-theme="dark"] {
      --primary: #6366f1;
      --secondary: #818cf8;
      --accent: #10b981;
      --background: #1a1a1a;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --error: #ef4444;
      --white: #1f2937;
      --card-bg: #2d2d2d;
      --day-cell-bg: #3d3d3d;
      --shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      font-size: var(--font-size-base);
      background-color: var(--background);
      color: var(--text);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: var(--card-bg);
      box-shadow: var(--shadow);
      margin-bottom: 15px;
      gap: 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      order: 1;
      flex: 1 0 100%;
    }

    .user-greeting {
      font-weight: 600;
      font-size: 1.1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .header-center {
      order: 3;
      flex: 1 0 100%;
      text-align: center;
    }

    .app-title {
      font-size: 1.8rem;
      color: var(--primary);
      margin: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      order: 2;
      flex: 1;
      justify-content: flex-end;
    }

    .badge {
      font-size: 0.9rem;
      padding: 5px 10px;
      border-radius: 12px;
      background-color: var(--accent);
      color: white;
      white-space: nowrap;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 1.3rem;
      transition: transform 0.2s;
      padding: 5px;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    #logoutBtn {
      background-color: var(--error);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    #logoutBtn:hover {
      opacity: 0.9;
    }

    /* Auth modal */
    #authModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--background);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 15px;
    }

    .auth-box {
      position: relative;
      overflow: hidden;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      width: 100%;
      max-width: 380px;
    }

    .auth-decoration {
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      pointer-events: none;
    }

    .decoration-circle,
    .decoration-square,
    .decoration-triangle {
      position: absolute;
      opacity: 0.1;
    }

    .decoration-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--primary);
      top: -20px;
      right: -20px;
    }

    .decoration-square {
      width: 40px;
      height: 40px;
      background-color: var(--accent);
      top: 40px;
      right: 30px;
      transform: rotate(15deg);
    }

    .decoration-triangle {
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 50px solid var(--secondary);
      top: 10px;
      right: 60px;
      transform: rotate(-15deg);
    }

    .auth-box h2 {
      font-size: 1.8rem;
      margin-bottom: 25px;
      color: var(--primary);
    }

    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    .auth-box input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid var(--muted);
      font-size: 1rem;
      background-color: var(--card-bg);
      color: var(--text);
    }

    .input-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .auth-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      background: var(--primary);
      color: white;
    }

    .auth-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .auth-button .button-icon {
      margin-left: 8px;
      font-weight: bold;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 15px;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      border-bottom: 2px solid var(--muted);
      font-size: 1rem;
      transition: all 0.2s;
      position: relative;
    }

    .auth-tab.active {
      border-bottom: 2px solid var(--primary);
      font-weight: bold;
    }

    .auth-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
      animation: tabSlide 0.3s ease-out;
    }

    @keyframes tabSlide {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }

    #loginForm {
      display: block;
    }

    #registerForm {
      display: none;
    }

    /* App layout */
    .controls, .tracker-container {
      width: calc(100% - 30px);
      margin: 15px auto;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-size: 1rem;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Month selector styles */
    .month-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      margin: 10px 0;
    }

    .month-nav-btn {
      background: var(--day-cell-bg);
      border: none;
      border-radius: 6px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      color: var(--text);
      transition: all 0.2s;
    }

    .month-nav-btn:hover {
      background: var(--primary);
      color: white;
    }

    .month-year-display {
      display: flex;
      gap: 5px;
    }

    .compact-select {
      padding: 5px 8px;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid var(--muted);
      background: var(--card-bg);
      color: var(--text);
      min-width: 75px;
      height: 30px;
    }

    input, select, button {
      padding: 10px;
      font-family: inherit;
      font-size: 1rem;
      border: 1px solid var(--muted);
      border-radius: 6px;
      background-color: var(--card-bg);
      color: var(--text);
      transition: border-color 0.2s;
      width: 100%;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
    }

    button {
      background-color: var(--primary);
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s, transform 0.1s;
    }

    button:hover {
      background-color: var(--secondary);
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* View toggle styles */
    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 10px;
    }

    .view-btn {
      padding: 5px 12px;
      border-radius: 15px;
      background: var(--day-cell-bg);
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .view-btn.active {
      background: var(--primary);
      color: white;
    }

    /* Category Filter */
    .category-filter {
      margin-bottom: 15px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
    }

    .category-filter label {
      font-size: 0.8rem;
      margin-bottom: 0;
    }

    .category-filter select {
      padding: 8px;
      font-size: 0.9rem;
    }

    /* Stats Container */
    .stats-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--shadow);
    }

    .stat-card h3 {
      margin-top: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .stat-card p {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 10px 0 0;
    }

    .chart-container {
      height: 250px;
      margin-top: 15px;
    }

    /* Habits grid */
    .habits-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .habit-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      min-width: 0;
    }

    .habit-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    .habit-card.dragging {
      opacity: 0.5;
      border: 2px dashed var(--primary);
    }

    .habit-card.archived {
      opacity: 0.7;
      background-color: var(--day-cell-bg);
    }

    .habit-header {
      padding: 15px;
      color: white;
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .habit-actions {
      display: flex;
      gap: 8px;
    }

    .habit-actions button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
      transition: transform 0.2s;
      min-width: 24px;
    }

    .habit-actions button:hover {
      transform: scale(1.2);
    }

    .habit-category {
      font-weight: normal; /* Unbold the category */
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 4px;
    }

    .calendar {
      padding: 15px;
    }

    .weekdays, .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 4px;
      font-size: 0.9rem;
    }

    .day-cell {
      background-color: var(--day-cell-bg);
      border-radius: 4px;
      padding: 8px 0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
    }

    .day-cell.checked {
      color: white;
    }

    .day-cell.future {
      opacity: 0.5;
      pointer-events: none;
    }

    .day-cell.highlight {
      transform: scale(1.1);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--muted);
      grid-column: 1 / -1;
      font-size: 1rem;
    }

    /* Make sure the tabs are consistent */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      gap: 5px;
    }

    .tab {
      padding: 5px 12px;
      border-radius: 15px;
      cursor: pointer;
      background: var(--day-cell-bg);
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: var(--accent);
      opacity: 0;
      z-index: 1000;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 1000;
      animation: fadeIn 0.3s;
      box-shadow: var(--shadow);
      font-size: 0.9rem;
      max-width: 90%;
      text-align: center;
    }

    /* Reminder Input */
    .reminder-input {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .reminder-input input {
      flex: 1;
    }

    /* Share Button */
    .share-btn {
      background-color: var(--accent) !important;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    @keyframes fadeIn {
      from { opacity: 0; bottom: 0; }
      to { opacity: 1; bottom: 10px; }
    }

    @media (min-width: 768px) {
      .app-header {
        flex-wrap: nowrap;
        padding: 20px;
      }
      
      .header-left {
        order: 1;
        flex: 0 1 auto;
        min-width: 0;
      }
      
      .header-center {
        order: 2;
        flex: 1;
      }
      
      .header-right {
        order: 3;
        flex: 0 1 auto;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .input-group {
        flex-direction: row;
      }
      
      .habits-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .category-filter {
        flex-direction: row;
        align-items: center;
      }
      
      .category-filter select {
        max-width: 200px;
      }
    }

    @media (min-width: 992px) {
      :root {
        --font-size-base: 16px;
      }
      
      .controls, .tracker-container {
        max-width: 1200px;
        padding: 20px;
      }
      
      .habits-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }
      
      .stats-container {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .habit-header {
        padding: 18px;
        font-size: 1.2rem;
      }
      
      .calendar {
        padding: 18px;
      }
      
      .weekdays, .days-grid {
        gap: 6px;
        font-size: 1rem;
      }
      
      .day-cell {
        padding: 10px 0;
      }
    }
  </style>
</head>
<body>
  <header class="app-header" style="display: none;">
    <div class="header-left">
      <span class="user-greeting" id="userGreeting"></span>
    </div>
    <div class="header-center">
      <h1 class="app-title">Habit Tracker</h1>
    </div>
    <div class="header-right">
      <div class="badge" id="activeHabitsBadge"></div>
      <button class="theme-toggle" id="themeToggle">üåì</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div id="authModal">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" id="loginTab">Login</div>
        <div class="auth-tab" id="registerTab">Register</div>
      </div>
      
      <div class="auth-decoration">
        <div class="decoration-circle"></div>
        <div class="decoration-square"></div>
        <div class="decoration-triangle"></div>
      </div>
      
      <div id="loginForm">
        <h2>Welcome Back!</h2>
        <div class="input-group">
          <input type="email" id="emailInput" placeholder="Email" />
          <i class="input-icon">‚úâÔ∏è</i>
        </div>
        <div class="input-group">
          <input type="password" id="passwordInput" placeholder="Password" />
          <i class="input-icon">üîí</i>
        </div>
        <button id="loginBtn" class="auth-button">
          <span class="button-text">Login</span>
          <span class="button-icon">‚Üí</span>
        </button>
      </div>
      
      <div id="registerForm" style="display: none;">
        <h2>Create Account</h2>
        <div class="input-group">
          <input type="text" id="nicknameInput" placeholder="Nickname" />
          <i class="input-icon">üë§</i>
        </div>
        <div class="input-group">
          <input type="email" id="emailRegisterInput" placeholder="Email" />
          <i class="input-icon">‚úâÔ∏è</i>
        </div>
        <div class="input-group">
          <input type="password" id="passwordRegisterInput" placeholder="Password" />
          <i class="input-icon">üîí</i>
        </div>
        <button id="registerBtn" class="auth-button">
          <span class="button-text">Register</span>
          <span class="button-icon">‚Üë</span>
        </button>
        <p class="auth-terms">By registering, you agree to our Terms and Privacy Policy</p>
      </div>
    </div>
  </div>

  <div class="controls" style="display: none;">
    <div class="input-group">
      <input type="text" id="newHabit" placeholder="New Habit (e.g. Drink Water)">
      <select id="habitCategory">
        <option value="Health">Health</option>
        <option value="Productivity">Productivity</option>
        <option value="Learning">Learning</option>
        <option value="Mindfulness">Mindfulness</option>
        <option value="Other">Other</option>
      </select>
      <div class="reminder-input">
        <input type="time" id="habitReminder" placeholder="Set reminder (optional)">
      </div>
      <button id="addHabit">Add Habit</button>
    </div>
    <div class="month-selector">
      <button id="prevMonth" class="month-nav-btn">‚Äπ</button>
      <div class="month-year-display">
        <select id="monthSelect" class="compact-select">
          <option value="0">Jan</option>
          <option value="1">Feb</option>
          <option value="2">Mar</option>
          <option value="3">Apr</option>
          <option value="4">May</option>
          <option value="5">Jun</option>
          <option value="6">Jul</option>
          <option value="7">Aug</option>
          <option value="8">Sep</option>
          <option value="9">Oct</option>
          <option value="10">Nov</option>
          <option value="11">Dec</option>
        </select>
        <select id="yearSelect" class="compact-select">
          <!-- Years will be populated by JavaScript -->
        </select>
      </div>
      <button id="nextMonth" class="month-nav-btn">‚Ä∫</button>
    </div>
  </div>

  <div class="tabs" id="habitTabs" style="display: none;">
    <div class="tab active" data-tab="active">Active Habits</div>
    <div class="tab" data-tab="archived">Archived</div>
  </div>

  <div class="tracker-container" id="trackerContainer">
    <div class="view-toggle">
      <button class="view-btn active" data-view="monthly">Month</button>
      <button class="view-btn" data-view="weekly">Week</button>
    </div>
    
    <div class="category-filter">
      <label for="filterCategory">Filter by Category:</label>
      <select id="filterCategory">
        <option value="all" selected>All Categories</option>
        <option value="Health">Health</option>
        <option value="Productivity">Productivity</option>
        <option value="Learning">Learning</option>
        <option value="Mindfulness">Mindfulness</option>
        <option value="Other">Other</option>
      </select>
    </div>
    
    <div class="stats-container" id="statsContainer">
      <!-- Stats cards will be inserted here -->
    </div>
    
    <div class="empty-state" id="emptyState">Please log in to view your habits.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATHwpakyFFbOWpZeA13P4A7AG6dOxk118",
      authDomain: "habittrackerapp-12f1a.firebaseapp.com",
      projectId: "habittrackerapp-12f1a",
      storageBucket: "habittrackerapp-12f1a.appspot.com",
      messagingSenderId: "946707596093",
      appId: "1:946707596093:web:5c4874ebd96d8e6ac2fb54",
      measurementId: "G-4Y1K3TNL0V"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    // DOM elements
    const authModal = document.getElementById('authModal');
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const nicknameInput = document.getElementById('nicknameInput');
    const emailRegisterInput = document.getElementById('emailRegisterInput');
    const passwordRegisterInput = document.getElementById('passwordRegisterInput');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const controls = document.querySelector('.controls');
    const trackerContainer = document.getElementById('trackerContainer');
    const emptyState = document.getElementById('emptyState');
    const appHeader = document.querySelector('.app-header');
    const userGreeting = document.getElementById('userGreeting');
    const themeToggle = document.getElementById('themeToggle');
    const activeHabitsBadge = document.getElementById('activeHabitsBadge');
    const habitTabs = document.getElementById('habitTabs');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const newHabitInput = document.getElementById('newHabit');
    const habitCategory = document.getElementById('habitCategory');
    const habitReminder = document.getElementById('habitReminder');
    const filterCategory = document.getElementById('filterCategory');
    const viewToggle = document.querySelector('.view-toggle');
    const statsContainer = document.getElementById('statsContainer');
    const addHabitBtn = document.getElementById('addHabit');

    // Generate random non-repeating colors
    const generateRandomColors = (count) => {
      const colors = [];
      const hueStep = 360 / count;
      
      for (let i = 0; i < count; i++) {
        const hue = Math.floor(i * hueStep);
        const saturation = 70 + Math.floor(Math.random() * 30);
        const lightness = 50 + Math.floor(Math.random() * 20);
        colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
      }
      
      // Shuffle the colors
      for (let i = colors.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [colors[i], colors[j]] = [colors[j], colors[i]];
      }
      
      return colors;
    };

    let habitColors = generateRandomColors(20);
    let colorIndex = 0;
    const getNextColor = () => {
      if (colorIndex >= habitColors.length) {
        habitColors = generateRandomColors(20);
        colorIndex = 0;
      }
      return habitColors[colorIndex++];
    };

    let currentUser = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let habits = [];
    let activeTab = 'active';
    let currentView = 'monthly';
    let longPressTimer = null;
    let isDragging = false;
    let draggedHabit = null;
    let draggedIndex = null;
    let userNickname = '';
    let charts = [];
    let isUpdating = false;

    // Theme handling
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeToggle.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      
      // Update Chart.js colors
      updateChartColors();
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    // Update Chart.js colors when theme changes
    function updateChartColors() {
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text');
      const mutedColor = getComputedStyle(document.documentElement).getPropertyValue('--muted');
      
      charts.forEach(chart => {
        if (chart && !chart._destroyed) {
          chart.options.scales.x.grid.color = mutedColor;
          chart.options.scales.y.grid.color = mutedColor;
          chart.options.scales.x.ticks.color = textColor;
          chart.options.scales.y.ticks.color = textColor;
          chart.update();
        }
      });
    }

    // Initialize theme from localStorage or prefer-color-scheme
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    setTheme(initialTheme);

    themeToggle.addEventListener('click', toggleTheme);

    // Update active habits badge
    function updateActiveHabitsBadge(habits) {
      const activeHabits = habits.filter(h => !h.archived).length;
      activeHabitsBadge.textContent = `${activeHabits} Active Habits`;
    }

    // Streak calculation
    function calculateCurrentStreak(dates) {
      if (!dates || dates.length === 0) return 0;
      
      const sortedDates = [...dates]
        .map(d => new Date(d))
        .sort((a, b) => b - a);
      
      let streak = 1;
      const oneDay = 24 * 60 * 60 * 1000;
      
      for (let i = 1; i < sortedDates.length; i++) {
        const diff = (sortedDates[i-1] - sortedDates[i]) / oneDay;
        if (diff === 1) {
          streak++;
        } else if (diff > 1) {
          break;
        }
      }
      
      return streak;
    }

    function calculateLongestStreak(dates) {
      if (!dates || dates.length === 0) return 0;
      
      const sortedDates = [...dates]
        .map(d => new Date(d))
        .sort((a, b) => b - a);
      
      let longest = 1;
      let current = 1;
      const oneDay = 24 * 60 * 60 * 1000;
      
      for (let i = 1; i < sortedDates.length; i++) {
        const diff = (sortedDates[i-1] - sortedDates[i]) / oneDay;
        if (diff === 1) {
          current++;
          longest = Math.max(longest, current);
        } else if (diff > 1) {
          current = 1;
        }
      }
      
      return longest;
    }

    // Calculate completion rate for a habit
    function calculateCompletionRate(habit, year, month) {
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const completedDays = habit.days?.filter(d => {
        const date = new Date(d);
        return date.getFullYear() === year && date.getMonth() === month;
      }).length || 0;
      
      return Math.round((completedDays / daysInMonth) * 100);
    }

    // Render statistics
    function renderStatistics() {
      statsContainer.innerHTML = '';
      
      // Destroy existing charts
      charts.forEach(chart => {
        if (chart && !chart._destroyed) {
          chart.destroy();
          chart._destroyed = true;
        }
      });
      charts = [];
      
      if (habits.length === 0) return;
      
      // Create chart containers first
      statsContainer.innerHTML = `
        <div class="stat-card">
          <h3>Overall Completion</h3>
          <p id="completionPercent">0%</p>
          <div class="chart-container">
            <canvas id="completionChart"></canvas>
          </div>
        </div>
        <div class="stat-card">
          <h3>Habits by Category</h3>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
        <div class="stat-card">
          <h3>Current Streak</h3>
          <p id="currentStreak">0 days</p>
        </div>
        <div class="stat-card">
          <h3>Longest Streak</h3>
          <p id="longestStreak">0 days</p>
        </div>
      `;

      // Calculate stats
      const completedHabits = habits.filter(h => !h.archived && h.days?.some(d => 
        new Date(d).getMonth() === currentMonth && 
        new Date(d).getFullYear() === currentYear
      )).length;
      
      const totalHabits = habits.filter(h => !h.archived).length;
      const overallCompletion = totalHabits > 0 ? Math.round((completedHabits / totalHabits) * 100) : 0;
      
      // Update completion percentage
      document.getElementById('completionPercent').textContent = `${overallCompletion}%`;
      
      // Update streaks
      const activeHabits = habits.filter(h => !h.archived);
      const currentStreaks = activeHabits.map(h => calculateCurrentStreak(h.days));
      const longestStreaks = activeHabits.map(h => calculateLongestStreak(h.days));
      
      document.getElementById('currentStreak').textContent = `${currentStreaks.length > 0 ? Math.max(...currentStreaks) : 0} days`;
      document.getElementById('longestStreak').textContent = `${longestStreaks.length > 0 ? Math.max(...longestStreaks) : 0} days`;
      
      // Only create charts if canvas elements exist
      setTimeout(() => {
        const completionCanvas = document.getElementById('completionChart');
        const categoryCanvas = document.getElementById('categoryChart');
        
        if (completionCanvas) {
          const completionCtx = completionCanvas.getContext('2d');
          const completionChart = new Chart(completionCtx, {
            type: 'doughnut',
            data: {
              labels: ['Completed', 'Remaining'],
              datasets: [{
                data: [overallCompletion, 100 - overallCompletion],
                backgroundColor: [
                  getComputedStyle(document.documentElement).getPropertyValue('--primary'),
                  getComputedStyle(document.documentElement).getPropertyValue('--muted')
                ],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text')
                  }
                }
              }
            }
          });
          charts.push(completionChart);
        }
        
        if (categoryCanvas) {
          const categories = {};
          habits.filter(h => !h.archived).forEach(habit => {
            const category = habit.category || 'Other';
            categories[category] = (categories[category] || 0) + 1;
          });
          
          const categoryCtx = categoryCanvas.getContext('2d');
          const categoryChart = new Chart(categoryCtx, {
            type: 'pie',
            data: {
              labels: Object.keys(categories),
              datasets: [{
                data: Object.values(categories),
                backgroundColor: [
                  '#4f46e5', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#6366f1'
                ],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text')
                  }
                }
              }
            }
          });
          charts.push(categoryChart);
        }
      }, 100);
    }

    // Setup reminders
    function setupReminders() {
      if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return;
      }
      
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('Notification permission granted');
          scheduleReminders();
        }
      });
    }

    function scheduleReminders() {
      habits.forEach(habit => {
        if (habit.reminderTime && !habit.archived) {
          const [hours, minutes] = habit.reminderTime.split(':');
          const now = new Date();
          const reminderTime = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            parseInt(hours),
            parseInt(minutes),
            0
          );
          
          if (now > reminderTime) {
            reminderTime.setDate(reminderTime.getDate() + 1);
          }
          
          const timeout = reminderTime.getTime() - now.getTime();
          
          setTimeout(() => {
            if (Notification.permission === 'granted') {
              new Notification(`Time for: ${habit.name}`, {
                body: `Don't forget to ${habit.name.toLowerCase()} today!`,
                icon: '/icon.png'
              });
            }
            
            // Schedule for next day
            scheduleReminders();
          }, timeout);
        }
      });
    }

    // Social sharing
    function shareHabit(habit) {
      if (navigator.share) {
        navigator.share({
          title: `My Habit: ${habit.name}`,
          text: `I've been tracking "${habit.name}" for ${calculateCurrentStreak(habit.days)} days!`,
          url: window.location.href
        }).catch(err => {
          console.log('Error sharing:', err);
        });
      } else {
        // Fallback for browsers that don't support Web Share API
        const shareUrl = `https://twitter.com/intent/tweet?text=I've been tracking "${habit.name}" for ${calculateCurrentStreak(habit.days)} days!&url=${encodeURIComponent(window.location.href)}`;
        window.open(shareUrl, '_blank');
      }
    }

    // Drag and drop functionality
    function setupDragAndDrop() {
      const habitsGrid = document.querySelector('.habits-grid');
      if (!habitsGrid) return;
      
      habitsGrid.addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(habitsGrid, e.clientY);
        const draggable = document.querySelector('.dragging');
        if (afterElement == null) {
          habitsGrid.appendChild(draggable);
        } else {
          habitsGrid.insertBefore(draggable, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.habit-card:not(.dragging)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Long press for multiple selection
    function setupLongPress() {
      document.addEventListener('mousedown', e => {
        if (e.target.classList.contains('day-cell')) {
          longPressTimer = setTimeout(() => {
            if (!e.target.classList.contains('future')) {
              e.target.classList.add('highlight');
              document.addEventListener('mouseover', handleDayHighlight);
            }
          }, 500);
        }
      });
      
      document.addEventListener('mouseup', () => {
        clearTimeout(longPressTimer);
        document.removeEventListener('mouseover', handleDayHighlight);
        document.querySelectorAll('.day-cell.highlight').forEach(cell => {
          cell.classList.remove('highlight');
        });
      });
      
      document.addEventListener('touchstart', e => {
        if (e.target.classList.contains('day-cell')) {
          longPressTimer = setTimeout(() => {
            if (!e.target.classList.contains('future')) {
              e.target.classList.add('highlight');
              document.addEventListener('touchmove', handleDayHighlight);
            }
          }, 500);
        }
      });
      
      document.addEventListener('touchend', () => {
        clearTimeout(longPressTimer);
        document.removeEventListener('touchmove', handleDayHighlight);
        document.querySelectorAll('.day-cell.highlight').forEach(cell => {
          cell.classList.remove('highlight');
        });
      });
    }

    function handleDayHighlight(e) {
      const dayCell = e.target.closest('.day-cell');
      if (dayCell && !dayCell.classList.contains('future')) {
        dayCell.classList.add('highlight');
      }
    }

    // Confetti effect
    function createConfetti() {
      const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'];
      const container = document.createElement('div');
      container.style.position = 'fixed';
      container.style.top = '0';
      container.style.left = '0';
      container.style.width = '100%';
      container.style.height = '100%';
      container.style.pointerEvents = 'none';
      container.style.zIndex = '1000';
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'absolute';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = '50%';
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.top = '-10px';
        confetti.style.opacity = '0';
        
        const animation = confetti.animate([
          { opacity: 0, top: '-10px', transform: 'rotate(0deg)' },
          { opacity: 1, top: `${Math.random() * 100}vh`, transform: 'rotate(360deg)' }
        ], {
          duration: 2000 + Math.random() * 3000,
          easing: 'cubic-bezier(0.1, 0.8, 0.3, 1)'
        });
        
        animation.onfinish = () => confetti.remove();
        container.appendChild(confetti);
      }
      
      document.body.appendChild(container);
      setTimeout(() => container.remove(), 3000);
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function initDateSelectors() {
      // Set current month
      monthSelect.value = currentMonth;
      
      // Populate years (current year -2 to +2)
      yearSelect.innerHTML = '';
      for (let y = currentYear - 2; y <= currentYear + 2; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      monthSelect.addEventListener('change', () => {
        currentMonth = parseInt(monthSelect.value);
        renderHabits();
      });

      yearSelect.addEventListener('change', () => {
        currentYear = parseInt(yearSelect.value);
        renderHabits();
      });

      document.getElementById('prevMonth').addEventListener('click', () => {
        if (currentMonth === 0) { currentMonth = 11; currentYear--; }
        else currentMonth--;
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        renderHabits();
      });

      document.getElementById('nextMonth').addEventListener('click', () => {
        if (currentMonth === 11) { currentMonth = 0; currentYear++; }
        else currentMonth++;
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        renderHabits();
      });
    }

    async function loadHabits() {
      if (!currentUser || isUpdating) return;
      isUpdating = true;
      
      try {
        // Show loading state
        emptyState.style.display = 'block';
        emptyState.textContent = 'Loading habits...';
        
        const snapshot = await getDocs(collection(db, "users", currentUser.uid, "habits"));
        habits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        updateActiveHabitsBadge(habits);
        renderStatistics();
        renderHabits();
        setupReminders();
      } catch (err) {
        showToast("Error loading habits: " + err.message);
      } finally {
        isUpdating = false;
      }
    }

    function renderHabits() {
      if (!trackerContainer) return;
      
      trackerContainer.innerHTML = '';
      
      const grid = document.createElement('div');
      grid.className = 'habits-grid';
      trackerContainer.appendChild(grid);
      
      // Add view toggle back
      if (viewToggle) trackerContainer.insertBefore(viewToggle, grid);
      if (filterCategory?.parentElement) trackerContainer.insertBefore(filterCategory.parentElement, grid);
      
      if (!habits || !Array.isArray(habits)) {
        emptyState.style.display = 'block';
        emptyState.textContent = 'Loading habits...';
        grid.appendChild(emptyState);
        return;
      }
      
      const filteredHabits = habits.filter(h => {
        const tabMatch = (activeTab === 'active' && !h.archived) || 
                         (activeTab === 'archived' && h.archived);
        const categoryMatch = filterCategory.value === 'all' || 
                             (h.category || 'Other') === filterCategory.value;
        return tabMatch && categoryMatch;
      });
      
      if (!filteredHabits.length) {
        emptyState.style.display = 'block';
        emptyState.textContent = activeTab === 'active' 
          ? 'No habits yet. Add one!' 
          : 'No archived habits';
        grid.appendChild(emptyState);
        return;
      }
      emptyState.style.display = 'none';

      const today = new Date();

      filteredHabits.forEach((habit) => {
        const card = document.createElement('div');
        card.className = `habit-card ${habit.archived ? 'archived' : ''}`;
        card.dataset.id = habit.id;

        const header = document.createElement('div');
        header.className = 'habit-header';
        header.style.backgroundColor = habit.color;
        header.dataset.habitId = habit.id;
        
        header.innerHTML = `
          <div>
            <span>${habit.name}</span>
            <div class="habit-category">${habit.category || 'Other'}</div>
          </div>
          <div class="habit-actions">
            <button class="archive-btn" title="${habit.archived ? 'Unarchive' : 'Archive'}">
              ${habit.archived ? '‚Üª' : 'üóÑ'}
            </button>
            <button class="delete-btn" title="Delete">‚úï</button>
          </div>
        `;

        const calendar = document.createElement('div');
        calendar.className = 'calendar';
        
        if (currentView === 'monthly') {
          const weekdays = document.createElement('div');
          weekdays.className = 'weekdays';
          weekdays.innerHTML = ['S','M','T','W','T','F','S'].map(d => `<div>${d}</div>`).join('');

          const daysGrid = document.createElement('div');
          daysGrid.className = 'days-grid';

          const firstDay = new Date(currentYear, currentMonth, 1).getDay();
          const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

          for (let i = 0; i < firstDay; i++) {
            daysGrid.innerHTML += `<div class="day-cell empty"></div>`;
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${currentMonth + 1}-${day}`;
            const isFuture = currentYear === today.getFullYear() && currentMonth === today.getMonth() && day > today.getDate();
            const isChecked = habit.days?.includes(dateStr);

            const cell = document.createElement('div');
            cell.className = 'day-cell';
            if (isFuture) cell.classList.add('future');
            if (isChecked) {
              cell.classList.add('checked');
              cell.style.backgroundColor = habit.color;
            }

            cell.textContent = day;
            if (!isFuture) {
              cell.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                // Get the correct habit reference
                const habitId = e.target.closest('.habit-card').dataset.id;
                const habitToUpdate = habits.find(h => h.id === habitId);
                if (!habitToUpdate) return;
                
                habitToUpdate.days = habitToUpdate.days || [];
                const index = habitToUpdate.days.indexOf(dateStr);
                
                try {
                  if (index === -1) {
                    habitToUpdate.days.push(dateStr);
                    if (habitToUpdate.days.length % 7 === 0) {
                      createConfetti();
                    }
                  } else {
                    habitToUpdate.days.splice(index, 1);
                  }
                  
                  // Update Firebase
                  await setDoc(doc(db, "users", currentUser.uid, "habits", habitId), habitToUpdate);
                  
                  // Update UI
                  cell.classList.toggle('checked');
                  cell.style.backgroundColor = cell.classList.contains('checked') ? habit.color : '';
                } catch (err) {
                  showToast("Error updating habit: " + err.message);
                }
              });
            }

            daysGrid.appendChild(cell);
          }

          calendar.appendChild(weekdays);
          calendar.appendChild(daysGrid);
        } else {
          // Weekly view
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          
          const weekdaysHeader = document.createElement('div');
          weekdaysHeader.className = 'weekdays';
          weekdaysHeader.innerHTML = ['S','M','T','W','T','F','S'].map(d => `<div>${d}</div>`).join('');
          
          const daysGrid = document.createElement('div');
          daysGrid.className = 'days-grid';
          
          for (let i = 0; i < 7; i++) {
            const currentDay = new Date(weekStart);
            currentDay.setDate(weekStart.getDate() + i);
            
            const dateStr = `${currentDay.getFullYear()}-${currentDay.getMonth() + 1}-${currentDay.getDate()}`;
            const isFuture = currentDay > today;
            const isChecked = habit.days?.includes(dateStr);
            
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            if (isFuture) cell.classList.add('future');
            if (isChecked) {
              cell.classList.add('checked');
              cell.style.backgroundColor = habit.color;
            }
            
            cell.textContent = currentDay.getDate();
            if (!isFuture) {
              cell.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                // Get the correct habit reference
                const habitId = e.target.closest('.habit-card').dataset.id;
                const habitToUpdate = habits.find(h => h.id === habitId);
                if (!habitToUpdate) return;
                
                habitToUpdate.days = habitToUpdate.days || [];
                const index = habitToUpdate.days.indexOf(dateStr);
                
                try {
                  if (index === -1) {
                    habitToUpdate.days.push(dateStr);
                  } else {
                    habitToUpdate.days.splice(index, 1);
                  }
                  
                  // Update Firebase
                  await setDoc(doc(db, "users", currentUser.uid, "habits", habitId), habitToUpdate);
                  
                  // Update UI
                  cell.classList.toggle('checked');
                  cell.style.backgroundColor = cell.classList.contains('checked') ? habit.color : '';
                } catch (err) {
                  showToast("Error updating habit: " + err.message);
                }
              });
            }
            
            daysGrid.appendChild(cell);
          }
          
          calendar.appendChild(weekdaysHeader);
          calendar.appendChild(daysGrid);
        }

        card.appendChild(header);
        card.appendChild(calendar);

        // Add share button
        const shareButton = document.createElement('button');
        shareButton.className = 'share-btn';
        shareButton.innerHTML = 'Share Progress üì§';
        shareButton.addEventListener('click', () => shareHabit(habit));
        card.appendChild(shareButton);

        grid.appendChild(card);

        // Archive button event listener
        header.querySelector('.archive-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          
          const habitId = e.target.closest('.habit-header').dataset.habitId;
          const habitToUpdate = habits.find(h => h.id === habitId);
          
          if (!habitToUpdate) return;
          
          try {
            // Show loading state
            e.target.innerHTML = '...';
            e.target.disabled = true;
            
            // Optimistically update local state
            habitToUpdate.archived = !habitToUpdate.archived;
            updateActiveHabitsBadge(habits);
            renderHabits();
            
            // Update Firebase
            await updateDoc(doc(db, "users", currentUser.uid, "habits", habitId), {
              archived: habitToUpdate.archived
            });
            
            showToast(`Habit ${habitToUpdate.archived ? 'archived' : 'unarchived'}!`);
          } catch (err) {
            // Rollback on error
            habitToUpdate.archived = !habitToUpdate.archived;
            updateActiveHabitsBadge(habits);
            renderHabits();
            showToast("Error updating habit: " + err.message);
          } finally {
            e.target.innerHTML = habitToUpdate.archived ? '‚Üª' : 'üóÑ';
            e.target.disabled = false;
          }
        });

        // Delete button event listener
        header.querySelector('.delete-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          
          const habitId = e.target.closest('.habit-header').dataset.habitId;
          const habitToDelete = habits.find(h => h.id === habitId);
          
          if (!habitToDelete) return;
          
          if (confirm(`Are you sure you want to delete "${habitToDelete.name}"?`)) {
            try {
              // Show loading state
              e.target.innerHTML = 'Deleting...';
              e.target.disabled = true;
              
              // Optimistically remove from local state
              habits = habits.filter(h => h.id !== habitId);
              updateActiveHabitsBadge(habits);
              renderHabits();
              
              // Delete from Firebase
              await deleteDoc(doc(db, "users", currentUser.uid, "habits", habitId));
              
              showToast(`Habit "${habitToDelete.name}" deleted!`);
            } catch (err) {
              // Rollback on error
              habits.push(habitToDelete);
              updateActiveHabitsBadge(habits);
              renderHabits();
              showToast("Error deleting habit: " + err.message);
            } finally {
              e.target.innerHTML = '‚úï';
              e.target.disabled = false;
            }
          }
        });
      });
      
      setupDragAndDrop();
    }

    addHabitBtn.addEventListener('click', async () => {
      const name = newHabitInput.value.trim();
      if (!name) return;
      
      // Check if habit already exists
      const habitExists = habits.some(h => h.name.toLowerCase() === name.toLowerCase());
      if (habitExists) {
        showToast(`Habit "${name}" already exists!`);
        return;
      }
      
      const newHabit = { 
        name, 
        color: getNextColor(), 
        days: [],
        category: habitCategory.value,
        reminderTime: habitReminder.value || null,
        createdAt: new Date(),
        id: name,
        archived: false
      };
      
      try {
        // Show loading state
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        addHabitBtn.appendChild(spinner);
        addHabitBtn.disabled = true;
        
        // Optimistic update
        habits.push(newHabit);
        newHabitInput.value = '';
        habitReminder.value = '';
        updateActiveHabitsBadge(habits);
        renderHabits();
        
        // Firebase update
        await setDoc(doc(db, "users", currentUser.uid, "habits", name), newHabit);
        
        showToast(`Habit "${name}" added!`);
        setupReminders();
      } catch (err) {
        // Rollback on error
        habits = habits.filter(h => h.id !== name);
        updateActiveHabitsBadge(habits);
        renderHabits();
        showToast("Error adding habit: " + err.message);
      } finally {
        addHabitBtn.disabled = false;
        const spinner = addHabitBtn.querySelector('.loading-spinner');
        if (spinner) spinner.remove();
      }
    });

    // Allow adding habit with Enter key
    newHabitInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addHabitBtn.click();
      }
    });

    // View toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        renderHabits();
      });
    });

    // Category filter
    filterCategory.addEventListener('change', () => {
      renderHabits();
    });

    // Auth tab switching
    loginTab.addEventListener('click', () => {
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
    });

    registerTab.addEventListener('click', () => {
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      registerForm.style.display = 'block';
      loginForm.style.display = 'none';
    });

    // Add animation to auth tabs
    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = 'scale(1)';
        }, 100);
      });
    });

    // Add animation to auth buttons
    document.querySelectorAll('.auth-button').forEach(button => {
      button.addEventListener('click', function() {
        this.style.transform = 'translateY(0) scale(0.98)';
        setTimeout(() => {
          this.style.transform = 'translateY(-2px) scale(1)';
        }, 100);
      });
    });

    loginBtn.addEventListener('click', async () => {
      try {
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      } catch (err) {
        showToast("Login error: " + err.message);
      }
    });

    registerBtn.addEventListener('click', async () => {
      try {
        const nickname = nicknameInput.value.trim();
        if (!nickname) {
          showToast("Please enter a nickname");
          return;
        }
        
        const userCredential = await createUserWithEmailAndPassword(auth, emailRegisterInput.value, passwordRegisterInput.value);
        // Store nickname in Firestore
        await setDoc(doc(db, "users", userCredential.user.uid), {
          nickname: nickname
        });
        userNickname = nickname;
      } catch (err) {
        showToast("Register error: " + err.message);
      }
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeTab = tab.dataset.tab;
        renderHabits();
      });
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      const isLoggedIn = !!user;
      authModal.style.display = isLoggedIn ? 'none' : 'flex';
      controls.style.display = isLoggedIn ? 'flex' : 'none';
      appHeader.style.display = isLoggedIn ? 'flex' : 'none';
      habitTabs.style.display = isLoggedIn ? 'flex' : 'none';
      
      if (isLoggedIn) {
        // Get user nickname
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          userNickname = userDoc.data().nickname || user.email;
        } else {
          userNickname = user.email;
        }
        userGreeting.textContent = `Hi, ${userNickname}`;
        
        // Initialize with current month/year
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
        
        initDateSelectors();
        setupLongPress();
        loadHabits();
      } else {
        // Reset form when logging out
        loginTab.click();
        emailInput.value = '';
        passwordInput.value = '';
        nicknameInput.value = '';
        emailRegisterInput.value = '';
        passwordRegisterInput.value = '';
      }
    });
  </script>
</body>
</html>
